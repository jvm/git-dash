name: Update Homebrew Tap (PR)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.1.0)"
        required: true
  release:
    types: [published]

permissions:
  contents: read

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            tag="${{ github.event.release.tag_name }}"
            version="${tag#v}"
          else
            version="${{ inputs.version }}"
          fi

          if [ -z "$version" ]; then
            echo "version is required" >&2
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Download release assets and compute checksums
        id: checksums
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          version="${VERSION}"
          base="https://github.com/jvm/git-dash/releases/download/v${version}"
          arm="git-dash-v${version}-aarch64-apple-darwin.tar.gz"
          intel="git-dash-v${version}-x86_64-apple-darwin.tar.gz"
          auth_header=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            auth_header=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi

          for asset in "$arm" "$intel"; do
            url="$base/$asset"
            curl -fL --retry 3 --retry-delay 2 "${auth_header[@]}" -o "$asset" "$url"
            tar -tzf "$asset" >/dev/null
            size=$(wc -c < "$asset")
            if [ "$size" -lt 100000 ]; then
              echo "downloaded asset too small: $asset ($size bytes)" >&2
              exit 1
            fi
          done

          arm_sha=$(shasum -a 256 "$arm" | awk '{print $1}')
          intel_sha=$(shasum -a 256 "$intel" | awk '{print $1}')

          if [ "$arm_sha" = "$intel_sha" ]; then
            echo "arm and intel checksums are identical; aborting" >&2
            exit 1
          fi

          echo "arm_sha=$arm_sha" >> "$GITHUB_OUTPUT"
          echo "intel_sha=$intel_sha" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: jvm/homebrew-tap
          token: ${{ secrets.TAP_REPO_TOKEN }}
          path: tap

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARM_SHA: ${{ steps.checksums.outputs.arm_sha }}
          INTEL_SHA: ${{ steps.checksums.outputs.intel_sha }}
          FORMULA: tap/Formula/git-dash.rb
        run: |
          python - <<'PY'
          import os
          import re

          version = os.environ["VERSION"]
          arm_sha = os.environ["ARM_SHA"]
          intel_sha = os.environ["INTEL_SHA"]
          path = os.environ["FORMULA"]

          with open(path, "r", encoding="utf-8") as f:
              text = f.read()

          def replace_once(pattern, repl, src, label):
              updated, count = re.subn(pattern, repl, src, flags=re.MULTILINE)
              if count != 1:
                  raise SystemExit(f"expected 1 {label} replacement, got {count}")
              return updated

          text = replace_once(
              r'version "\d+\.\d+\.\d+"',
              f'version "{version}"',
              text,
              "version",
          )
          text = replace_once(
              r'(url "https://github.com/jvm/git-dash/releases/download/v)[^/]+(/git-dash-v)[^/]+(-aarch64-apple-darwin\.tar\.gz")',
              rf"\1{version}\2{version}\3",
              text,
              "arm url",
          )
          text = replace_once(
              r'(url "https://github.com/jvm/git-dash/releases/download/v)[^/]+(/git-dash-v)[^/]+(-x86_64-apple-darwin\.tar\.gz")',
              rf"\1{version}\2{version}\3",
              text,
              "intel url",
          )
          text = replace_once(
              r'(aarch64-apple-darwin\.tar\.gz"\n\s+sha256 ")[^"]+(")',
              rf"\1{arm_sha}\2",
              text,
              "arm sha",
          )
          text = replace_once(
              r'(x86_64-apple-darwin\.tar\.gz"\n\s+sha256 ")[^"]+(")',
              rf"\1{intel_sha}\2",
              text,
              "intel sha",
          )

          with open(path, "w", encoding="utf-8") as f:
              f.write(text)
          PY

      - name: Commit changes
        id: commit
        run: |
          version="${{ steps.version.outputs.version }}"
          branch="update-git-dash-${version}"
          cd tap
          git checkout -B "$branch"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Formula/git-dash.rb
          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "Update git-dash to v${version}"
          git push -u origin "$branch" --force
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Open pull request
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.TAP_REPO_TOKEN }}
        run: |
          version="${{ steps.version.outputs.version }}"
          branch="update-git-dash-${version}"
          if gh pr view --repo jvm/homebrew-tap --head "$branch" >/dev/null 2>&1; then
            echo "PR already exists for $branch"
            exit 0
          fi
          gh pr create \
            --repo jvm/homebrew-tap \
            --title "Update git-dash to v${version}" \
            --body "Automated update from git-dash release v${version}." \
            --head "$branch" \
            --base main
